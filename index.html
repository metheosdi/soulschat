<script>
    // ********************************************
    // CONFIGURA√á√ÉO IMPORTANTE: URL DO SEU BACKEND
    // ********************************************
    const serverUrl = 'https://cdn.socket.io/4.5.0/socket.io.min.js'; // Substitua pela sua URL real
    // ********************************************

    let socket = null;
    let isTryingToReconnect = false;
    const statusElement = document.getElementById('connection-status');

    function connectToServer() {
        // Se j√° existe uma conex√£o, n√£o cria outra
        if (socket?.connected) {
            console.log('J√° conectado. Ignorando tentativa de reconex√£o.');
            return;
        }

        // Se j√° existe um socket (mesmo desconectado), destr√≥i a inst√¢ncia anterior para evitar lixo
        if (socket) {
            socket.removeAllListeners(); // Remove todos os ouvintes de eventos antigos
            socket.disconnect(); // For√ßa a desconex√£o da inst√¢ncia anterior
        }

        console.log('Tentando conectar ao servidor...');
        isTryingToReconnect = true;
        // Tenta conectar ao servidor
        socket = io(serverUrl);

        socket.on('connect', () => {
            console.log('Conectado!');
            isTryingToReconnect = false;
            statusElement.textContent = 'üü¢ Conectado';
            statusElement.style.color = 'lightgreen';
            addSystemMessage('Voc√™ se conectou ao chat.');
        });

        socket.on('disconnect', (reason) => {
            console.log('Desconectado:', reason);
            statusElement.textContent = 'üî¥ Desconectado';
            statusElement.style.color = 'lightpink';
            addSystemMessage('Voc√™ foi desconectado. Tentando reconectar...');

            // Tentativa de reconex√£o autom√°tica ap√≥s 3 segundos
            // Usa uma flag para evitar m√∫ltiplas tentativas simult√¢neas
            if (!isTryingToReconnect) {
                setTimeout(connectToServer, 3000);
            }
        });

        // Este √© o √∫nico lugar onde mensagens recebidas do servidor s√£o exibidas!
        socket.on('receber-mensagem', (data) => {
            console.log('Mensagem recebida do servidor:', data.texto);
            addMessageToChat(data.texto, false);
        });

        socket.on('connect_error', (error) => {
            console.error('Erro de conex√£o:', error);
            addSystemMessage('Falha ao conectar ao servidor.');
            // Agenda uma nova tentativa mesmo em caso de erro inicial
            if (!isTryingToReconnect) {
                setTimeout(connectToServer, 3000);
            }
        });
    }

    // Inicia a conex√£o quando a p√°gina carrega
    window.addEventListener('load', connectToServer);

    // Controle de UI
    const template1 = document.getElementById('template-1');
    const word1 = document.getElementById('word-1');
    const secondLine = document.getElementById('second-line');

    function updateSecondLineVisibility() {
        secondLine.style.display = (template1.value && word1.value) ? 'block' : 'none';
    }
    word1.addEventListener('change', updateSecondLineVisibility);
    template1.addEventListener('change', updateSecondLineVisibility);

    // Enviar Mensagem
    document.getElementById('send-button').addEventListener('click', enviarMensagem);

    function enviarMensagem() {
        const t1 = template1.value;
        const w1 = word1.value;
        const conj = document.getElementById('conjunction').value;
        const t2 = document.getElementById('template-2').value;
        const w2 = document.getElementById('word-2').value;
        const gesto = document.getElementById('gesture').value;

        if (!t1 || !w1) {
            alert('Precursor, complete a mensagem! Pelo menos um Modelo e uma Palavra s√£o necess√°rios.');
            return;
        }

        let msg = t1.replace('****', w1);

        if (conj && t2 && w2) {
            const secondPart = t2.replace('****', w2);
            msg += ` ${conj} ${secondPart}`;
        }

        if (gesto) {
            msg += ` ${gesto}`;
        }

        // Emite a mensagem apenas se estiver conectado
        if (socket && socket.connected) {
            socket.emit('enviar-mensagem', { texto: msg });
            // N√ÉO chame addMessageToChat aqui! Deixe o servidor enviar de volta.
            clearForm();
        } else {
            addSystemMessage('Erro: N√£o conectado ao servidor. Mensagem n√£o enviada.');
        }
    }

    function clearForm() {
        template1.selectedIndex = 0;
        word1.selectedIndex = 0;
        document.getElementById('conjunction').selectedIndex = 0;
        document.getElementById('template-2').selectedIndex = 0;
        document.getElementById('word-2').selectedIndex = 0;
        document.getElementById('gesture').selectedIndex = 0;
        secondLine.style.display = 'none';
    }

    // Gerenciar Chat
    function addMessageToChat(text, isSelf = false) {
        const msgElement = document.createElement('div');
        msgElement.classList.add('message');
        if (isSelf) msgElement.classList.add('self');
        msgElement.textContent = text;

        const chatContainer = document.getElementById('chat-container');
        chatContainer.appendChild(msgElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addSystemMessage(text) {
        const sysElement = document.createElement('div');
        sysElement.classList.add('message', 'system-msg');
        sysElement.textContent = text;

        const chatContainer = document.getElementById('chat-container');
        chatContainer.appendChild(sysElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
</script>
