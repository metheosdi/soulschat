<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Souls</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <!-- Manifest PWA -->
<link rel="manifest" href="/manifest.json">

<!-- Meta tags para PWA -->
<meta name="theme-color" content="#753">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Chat Souls">

<!-- √çcones para iOS -->
<link rel="apple-touch-icon" href="/icon-192.png">

<!-- Meta tags para melhor experi√™ncia mobile -->
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
    <style>
        :root {
            --color-bg: #222;
            --color-ui-dark: #111;
            --color-ui-light: #332;
            --color-accent: #753;
            --color-text: #ddd;
        }
        body {
            font-family: 'Times New Roman', serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }
        .header {
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid #333;
        }
        #chat-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem 0;
        }
        .message {
            background: #441201;
            color: #fff;
            padding: 0.8rem 1.2rem;
            border-radius: 5px;
            max-width: 80%;
            align-self: flex-start;
            word-wrap: break-word;
            border: 1px solid var(--color-accent);
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
        .message.self {
            align-self: flex-end;
            background: #1a3a2b;
        }
        .system-msg {
            color: #aaa;
            font-style: italic;
            align-self: center;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        #creator-menu {
            background-color: var(--color-ui-light);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid var(--color-accent);
        }
        .dropdown {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            background-color: var(--color-ui-dark);
            color: var(--color-text);
            border: 1px solid var(--color-accent);
            border-radius: 4px;
        }
        #send-button {
            width: 100%;
            padding: 0.8rem;
            background-color: var(--color-accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .menu-section {
            margin-bottom: 1rem;
        }
        #connection-status {
            font-weight: bold;
        }
        #clear-history-btn, #notif-btn {
            position: fixed;
            padding: 0.5rem;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #clear-history-btn {
            bottom: 5rem;
            right: 2rem;
            background: #600;
        }
        #notif-btn {
            bottom: 8rem;
            right: 2rem;
            background: #335;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Message App</h1>
        <p>Status: <span id="connection-status">üî¥ Desconectado</span></p>
    </div>

    <div id="chat-container">
        <div class="message system-msg">Bem-vindo, Precursor. Use a lousa para deixar sua mensagem.</div>
    </div>

    <div id="creator-menu">
        <div class="menu-section">
            <select class="dropdown" id="template-1">
                <option value="">[Modelo]</option>
                <option value="Cuidado com ****">Cuidado com ****</option>
                <option value="**** adiante">**** adiante</option>
                <option value="Sem **** √† frente">Sem **** √† frente</option>
                <option value="**** Necess√°rio adiante">**** Necess√°rio adiante</option>
                <option value="Tente ****">Tente ****</option>
                <option value="Provavel ****">Provavel ****</option>
                <option value="Primeiro, ****">Primeiro, ****</option>
                <option value="Busque ****">Busque ****</option>
                <option value="Ainda sem ****">Ainda sem ****</option>
                <option value="Por que sempre ****?">Por que sempre ****?</option>
                <option value="Se eu tivesse ****...">Se eu tivesse ****... </option>
                <option value="N√£o esperava ****...">N√£o esperava ****...</option>
                <option value="Vis√µes de ****...">Vis√µes de ****...</option>
                <option value="Poderia ser ****? ">Poderia ser ****? </option>
                <option value="Hora de ****...">Hora de ****...</option>
                <option value="**** oh, ****... ">**** oh, ****... </option>
                <option value="Ofere√ßa ****">Ofere√ßa ****</option>
                <option value="Louvado seja ****">Louvado seja ****</option>
                <option value="Que haja ****">Que haja ****</option>
                <option value="****">****</option>
                <option value="****!">****!</option>
                <option value="****?">****?</option>
                <option value="****...">****...</option>
                <option value="Ahh, ****...">Ahh, ****...</option>
            </select>
            <select class="dropdown" id="word-1">
                <option value="">[Palavras]</option>
                <!-- Ser√° preenchido automaticamente pelo JavaScript -->
            </select>
        </div>

        <div class="menu-section" id="second-line" style="display: none;">
            <select class="dropdown" id="conjunction">
                <option value="">[Conjun√ß√£o]</option>
                <option value="e ent√£o">e ent√£o</option>
                <option value="ou">ou</option>
                <option value="mas">mas</option>
                <option value="portanto">portanto</option>
                <option value="em suma">em suma</option>
                <option value="exceto">exceto</option>
                <option value="A prop√≥sito">A prop√≥sito</option>
                <option value="por assim dizer">por assim dizer</option>
                <option value="ainda mais">ainda mais</option>
                <option value=",">,</option>
            </select>
            <select class="dropdown" id="template-2">
                <option value="">[Modelo 2]</option>
                <option value="Cuidado com ****">Cuidado com ****</option>
                <option value="**** adiante">**** adiante</option>
                <option value="Sem **** √† frente">Sem **** √† frente</option>
                <option value="**** Necess√°rio adiante">**** Necess√°rio adiante</option>
                <option value="Tente ****">Tente ****</option>
                <option value="Provavel ****">Provavel ****</option>
                <option value="Primeiro, ****">Primeiro, ****</option>
                <option value="Busque ****">Busque ****</option>
                <option value="Ainda sem ****">Ainda sem ****</option>
                <option value="Por que sempre ****?">Por que sempre ****?</option>
                <option value="Se eu tivesse ****...">Se eu tivesse ****... </option>
                <option value="N√£o esperava ****...">N√£o esperava ****...</option>
                <option value="Vis√µes de ****...">Vis√µes de ****...</option>
                <option value="Poderia ser ****? ">Poderia ser ****? </option>
                <option value="Hora de ****...">Hora de ****...</option>
                <option value="**** oh, ****... ">**** oh, ****... </option>
                <option value="Ofere√ßa ****">Ofere√ßa ****</option>
                <option value="Louvado seja ****">Louvado seja ****</option>
                <option value="Que haja ****">Que haja ****</option>
                <option value="****">****</option>
                <option value="****!">****!</option>
                <option value="****?">****?</option>
                <option value="****...">****...</option>
                <option value="Ahh, ****...">Ahh, ****...</option>
            </select>
            <select class="dropdown" id="word-2">
                <option value="">[Palavra 2]</option>
                <!-- Ser√° preenchido automaticamente pelo JavaScript -->
            </select>
        </div>

        <div class="menu-section">
<select class="dropdown" id="gesture">
    <option value="">[Gestos]</option>
    
    <!-- ‚ú® Gestos ic√¥nicos -->
    <option value="üïäÔ∏è‚ú®">Anel de Miquella</option>
    <option value="‚öîÔ∏èü§ù">Que ven√ßa o melhor</option>
    <option value="‚úåÔ∏èüôè">Os dois dedos</option>
    <option value="ü§ùüôÇ">Vamos juntos</option>
    <option value="üôèüåô">√ì M√£e</option>
    
    <!-- üëâ Apontar -->
    <option value="üëâ">Apontar para a frente</option>
    <option value="‚òùÔ∏è">Apontar para cima</option>
    <option value="üëá">Apontar para baixo</option>
    
    <!-- ‚úã Movimentos de m√£o -->
    <option value="‚úãüòÆ">Esperar!</option>
    <option value="üñêÔ∏èüòå">Acalmar!</option>
    <option value="üëã">Onda</option>
    <option value="üëãüôÇ">Acenar</option>
    
    <!-- üëã Sauda√ß√µes -->
    <option value="üôå">Sauda√ß√£o casual</option>
    <option value="ü§ó">Calorosas boas-vindas</option>
    <option value="üí™üî•">For√ßa!</option>
    <option value="üëèüëè">Bravo!</option>
    <option value="ü§∏‚Äç‚ôÇÔ∏èüéâ">Pule de alegria</option>
    <option value="üèÜüò§">Prazer Triunfante</option>
    <option value="üíÉ‚ú®">Giro extravagante</option>
    
    <!-- ü§î Pensamento / Express√µes -->
    <option value="ü§î">Aceno de cabe√ßa em pensamento</option>
    <option value="ü´∞">Estalar de dedos</option>
    <option value="üò±">Grito</option>
    <option value="üì£üí™">Grito encorajador</option>
    
    <!-- üôá Respeito -->
    <option value="üôá">Curvar-se</option>
    <option value="üôá‚Äç‚ôÇÔ∏è">Rever√™ncia educada</option>
    <option value="ü§≤">Como voc√™ deseja</option>
    <option value="üôè">Meus agradecimentos</option>
    <option value="üôá‚Äç‚ôÄÔ∏è">Curtsy</option>
    <option value="üõê">Reverential Bow</option>
    <option value="ü§¥üôè">Meu Senhor</option>
    
    <!-- ‚ùì Rea√ß√µes -->
    <option value="ü§®">O que voc√™ quer?</option>
    <option value="‚öîÔ∏è‚úã">Pela minha espada</option>
    <option value="ü§û‚öîÔ∏è">Juramento de Hoslow</option>
    <option value="üî•üò§">Fogo Me Estimula</option>
    <option value="üíç‚ú®">O Anel</option>
    
    <!-- üìö Espiritualidade -->
    <option value="üìñ‚ú®">Erudi√ß√£o</option>
    <option value="üôè">Ora√ß√£o</option>
    <option value="üôèüò≠">Ora√ß√£o Desesperada</option>
    <option value="ü§©üôå">Arrebatamento</option>
    <option value="üåÄ">Ordem Interna</option>
    <option value="üåû‚ú®">Totalidade da Ordem Dourada</option>
    <option value="üòîüôè">Arrependimento Extremo</option>
    <option value="üßé‚Äç‚ôÇÔ∏èüõê">Rastejar por miseric√≥rdia</option>
    
    <!-- ü™ë Sentar / descanso -->
    <option value="üßò‚Äç‚ôÇÔ∏è">Pernas cruzadas</option>
    <option value="üò¥üßò‚Äç‚ôÇÔ∏è">Cochilo de pernas</option>
    <option value="ü™ëüôÇ">Sentado de lado</option>
    <option value="üßò‚Äç‚ôÄÔ∏èüòå">Descansar cruzadas</option>
    <option value="üòû">Des√¢nimo</option>
    <option value="üßé‚Äç‚ôÇÔ∏èüëÄ">Agachamento de Patches</option>
    <option value="üåÄüò£">Enrolado</option>
    <option value="üåå‚ú®">Espalhar</option>
</select>

        </div>
        <button id="send-button">Deixar Mensagem</button>
        <button id="clear-history-btn">Limpar Hist√≥rico</button>
        <button id="notif-btn">üîî Notifica√ß√µes</button>
    </div>

<script>
    // CONFIGURA√á√ÉO
    const serverUrl = 'https://soulschat.onrender.com';
    let socket = null;
    let isTryingToReconnect = false;
    let lastMessageText = '';
    const statusElement = document.getElementById('connection-status');

    // FUN√á√ÉO PARA PREENCHER DROPDOWNS COM PALAVRAS
    function preencherDropdownPalavras(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        
        // Limpa o dropdown (mant√©m apenas a primeira option)
        while (dropdown.options.length > 1) {
            dropdown.remove(1);
        }
        
        // Todas as palavras organizadas por categoria
        const palavras = {
            "Inimigos": [
                "Inimigo", "Inimigo Fraco", "Inimigo Forte", "Monstro", "drag√£o", "Chefe", "Sentinela", 
                "Grupo", "Bando", "Chamariz", "Morto-Vivo", "soldado", "cavaleiro", "Cavalheiro", 
                "Arqueiro", "Atirador", "Mago", "artilharia", "monarca", "demi-humano", "estrangeiro", 
                "gigante", "cavalo", "cachorro", "lobo", "rato", "fera", "p√°ssaro", "ave de rapina", 
                "cobra", "carangueijo", "camar√£o", "polvo", "inseto", "escaravelho", "lesma", "apari√ß√£o", 
                "esqueleto", "monstruosidade", "criatura agourenta"
            ],
            "Pessoas": [
                "Maculado", "guerreiro", "espadachim", "cavaleiro", "Samurai", "feiticeiro", "cl√©rigo", 
                "s√°bio", "professor", "mestre", "amigo", "amante", "velho querido", "velho maluco", 
                "anjo", "Bolsa de moedas cheia", "pobre", "boa pessoa", "pessoa perversa", "pessoa gorda", 
                "pessoa magra", "pessoa ador√°vel", "pessoa pat√©tica", "pessoa estranha", "pessoa agil", 
                "pessoa lenta", "pessoa invisivel", "pessoa gigante", "pescador", "ladr√£o", "mentiroso", 
                "covarde", "traidor", "par", "trio", "nobre", "aristocrata", "her√≥i", "campe√£o", 
                "monarca", "senhor", "deus"
            ],
            "Coisas": [
                "item", "item neces√°rio", "item precioso", "algo", "algo incr√≠vel", "Tesouro", "cadaver", 
                "caix√£o", "armadilha", "escudo", "arco", "arma de proj√©til", "armadura", "talism√£", 
                "habilidade", "feiti√ßaria", "encantamento", "mapa", "material", "flor", "grama", "√°rvore", 
                "fruta", "semente", "cogumelo", "l√°grima", "cristal", "borboleta", "inseto", "estrume", 
                "gra√ßa", "porta", "chave", "escada", "alavanca", "elevador", "Nascente de esp√≠rito", 
                "port√£o de envio", "astrol√°bio de pedra", "telescopio", "mensagem", "mancha", "T√©rvore", 
                "Elden Ring"
            ],
            "T√°tica de Batalha": [
                "desespero", "Batalha Corpo a Corpo", "Batalha √† distancia", "Batalha a cavalo", "atrair", 
                "Dorrotar um por um", "Derrotando todos de uma vez", "correndo", "furtividade", "mimetismo", 
                "confus√£o", "persegui√ß√£o", "fugindo", "Invoca√ß√£o", "circulando", "pulando", "breve pausa"
            ],
            "A√ß√µes": [
                "Atacando", "ataque com salto", "ataque com corrida", "acerto critico", 
                "segurar com as duas m√£os", "bloqueio", "aparando", "contra-ataque", "feiti√ßaria", 
                "encantamento", "habilidade", "invoca√ß√£o", "arremessando", "curando", "correndo", 
                "rolando", "retrocedendo", "pulando", "agachado", "travar a mira", "cria√ß√£o de itens", 
                "gesticulando"
            ],
            "Situa√ß√µes": [
                "Manh√£", "Meio-dia", "Noite", "c√©u claro", "nublado", "chuva", "tempestade", "n√©voa", 
                "neve", "Patrulhando", "prociss√£o", "multid√£o", "Ataque surpresa", "emboscada", "cercado", 
                "reduzido a p√≥", "batalha", "Refor√ßos", "Ritual", "explos√£o", "local alto", 
                "local defens√°vel", "local escal√°vel", "local brilhante", "local escura", "√°rea aberta", 
                "√°rea apertada", "esconderijo", "local de atirar", "local de reconhecimento", "seguran√ßa", 
                "perigo", "vista deslumbrante", "desvio", "caminho oculto", "Passagem secreta", "atalho", 
                "impasse", "desviando o olhar", "despercebido", "sem vigor"
            ],
            "Trajeto": [
                "Leste", "Oeste", "Sul", "Norte", "adiante", "atr√°s", "Esquerda", "Direita", "centro", 
                "em cima", "abaixo", "borda"
            ],
            "Partes do corpo": [
                "cabe√ßa", "est√¥mago", "Costas", "bra√ßos", "perna", "garupa", "cauda", "n√∫cleo", "Dedos"
            ],
            "Afinidades": [
                "f√≠sico", "padr√£o", "contundente", "Cortar", "penetrante", "Fogo", "rel√¢mpago", "magia", 
                "santo", "veneno", "t√≥xico", "podrid√£o escarlate", "perda de sangue", "geada", "dormir", 
                "loucura", "morte"
            ],
            "Conceitos": [
                "vida", "Morte", "luz", "escuro", "Estrelas", "Fogo", "Ordem", "caos", "alegria", "ira", 
                "sofrimento", "tristeza", "confortar", "bem-aventuran√ßa", "infort√∫nio", "boa sorte", "azar", 
                "esperan√ßa", "desespero", "vit√≥ria", "derrota", "investiga√ß√£o", "f√©", "abund√¢ncia", 
                "podrid√£o", "lealdade", "injusti√ßa", "segredo", "oportunidade", "apuro", "pista", "amizade", 
                "amor", "valentia", "vigor", "firmeza", "confian√ßa", "distra√≠do", "Desprotegido", 
                "introspec√ß√£o", "lamentar", "arrependimento", "futilidade", "√† beira do abismo", "trai√ß√£o", 
                "vingan√ßa", "destrui√ß√£o", "imprud√™ncia", "calma", "vigil√¢ncia", "tranquilidade", "som", 
                "l√°grimas", "dormir", "profundezidade", "esc√≥ria", "medo", "sacrif√≠cio", "ru√≠na"
            ],
            "Frases": [
                "Boa sorte", "Olhe com aten√ß√£o", "Ou√ßa com aten√ß√£o", "Pense com cuidado", "Muito bem", 
                "Eu fiz isso!", "Eu falhei...", "aqui!", "Aqui n√£o!", "N√£o se atreva!", "Fa√ßa isso!", 
                "Eu n√£o aguento isso...", "n√£o pense", "t√£o solit√°rio...", "aqui de novo...", 
                "apenas come√ßando", "Mantenha a calma", "continue se movendo", "voltar", "desistir", 
                "N√£o desista", "Me ajuda...", "Eu n√£o acredito...", "muito alto", "Eu quero ir para casa...", 
                "√© como um sonho...", "parece familiar ...", "bonito...", "voc√™ n√£o tem o direito", 
                "Est√° pronto?"
            ]
        };
        
        // Adiciona as palavras ao dropdown
        for (const [categoria, palavrasArray] of Object.entries(palavras)) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = categoria;
            
            palavrasArray.forEach(palavra => {
                const option = document.createElement('option');
                option.value = palavra;
                option.textContent = palavra;
                optgroup.appendChild(option);
            });
            
            dropdown.appendChild(optgroup);
        }
    }

    // FUN√á√ïES DE ARMAZENAMENTO LOCAL
    function saveChatHistory() {
        const chatContainer = document.getElementById('chat-container');
        const chatHTML = chatContainer.innerHTML;
        localStorage.setItem('soulsChatHistory', chatHTML);
    }

    function loadChatHistory() {
        const savedHistory = localStorage.getItem('soulsChatHistory');
        if (savedHistory) {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = savedHistory;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }

    function clearChatHistory() {
        if (confirm('Deseja apagar todo o hist√≥rico de mensagens?')) {
            localStorage.removeItem('soulsChatHistory');
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '<div class="message system-msg">Bem-vindo, Precursor. Use a lousa para deixar sua mensagem.</div>';
            addSystemMessage('Hist√≥rico limpo.');
        }
    }

    // FUN√á√ÉO PARA VERIFICAR ESTADO DAS NOTIFICA√á√ïES
    function verificarEstadoNotificacoes() {
        if ('Notification' in window) {
            console.log('Suporte a notifica√ß√µes: Sim');
            console.log('Permiss√£o atual:', Notification.permission);
            
            if (Notification.permission === 'default') {
                console.log('Solicitando permiss√£o explicitamente...');
                Notification.requestPermission().then(permission => {
                    console.log('Permiss√£o definida como:', permission);
                });
            }
        } else {
            console.log('Suporte a notifica√ß√µes: N√£o');
        }
    }

    // FUN√á√ÉO DE NOTIFICA√á√ïES ATUALIZADA
    function mostrarNotificacao(mensagem) {
        if (!('Notification' in window)) {
            console.log('Este browser n√£o suporta notifica√ß√µes');
            return;
        }

        console.log('Tentando mostrar notifica√ß√£o para:', mensagem);
        console.log('Permiss√£o atual:', Notification.permission);
        console.log('Janela em foco?', !document.hidden);

        // S√≥ mostra notifica√ß√£o se a janela n√£o estiver em foco
        if (document.hidden) {
            if (Notification.permission === 'granted') {
                try {
                    const notificacao = new Notification('üí¨ Message App', {
                        body: mensagem,
                        icon: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23441201"/><text x="50" y="50" font-size="40" text-anchor="middle" fill="white">üí¨</text></svg>',
                        tag: 'souls-chat',
                        requireInteraction: false
                    });

                    console.log('Notifica√ß√£o criada com sucesso');

                    setTimeout(() => {
                        notificacao.close();
                    }, 7000);

                    notificacao.onclick = function() {
                        window.focus();
                        this.close();
                    };

                } catch (error) {
                    console.error('Erro ao criar notifica√ß√£o:', error);
                }
            } else if (Notification.permission !== 'denied') {
                console.log('Solicitando permiss√£o...');
                Notification.requestPermission().then(permission => {
                    console.log('Nova permiss√£o:', permission);
                    if (permission === 'granted') {
                        mostrarNotificacao(mensagem);
                    }
                });
            }
        } else {
            console.log('Notifica√ß√£o n√£o mostrada: janela est√° em foco');
        }
    }

    // CONEX√ÉO COM SERVIDOR
    function connectToServer() {
        if (socket?.connected) return;
        if (socket) {
            socket.removeAllListeners();
            socket.disconnect();
        }

        console.log('Tentando conectar...');
        isTryingToReconnect = true;
        socket = io(serverUrl);

        socket.on('connect', () => {
            console.log('Conectado!');
            isTryingToReconnect = false;
            statusElement.textContent = 'üü¢ Conectado';
            statusElement.style.color = 'lightgreen';
            addSystemMessage('Voc√™ se conectou ao chat.');
        });

        socket.on('historico-completo', (historico) => {
            console.log('Hist√≥rico recebido:', historico);
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '<div class="message system-msg">Bem-vindo, Precursor. Use a lousa para deixar sua mensagem.</div>';
            
            historico.forEach(msg => {
                addMessageToChat(msg, false);
            });
            addSystemMessage('Hist√≥rico carregado.');
        });

        socket.on('receber-mensagem', (data) => {
            console.log('Mensagem recebida:', data.texto);
            addMessageToChat(data.texto, false);
            
            // Tenta mostrar notifica√ß√£o com pequeno delay
            setTimeout(() => {
                mostrarNotificacao(data.texto);
            }, 1000);
        });

        socket.on('disconnect', (reason) => {
            console.log('Desconectado:', reason);
            statusElement.textContent = 'üî¥ Desconectado';
            statusElement.style.color = 'lightpink';
            addSystemMessage('Desconectado. Reconectando...');
            if (!isTryingToReconnect) setTimeout(connectToServer, 3000);
        });

        socket.on('connect_error', (error) => {
            console.error('Erro de conex√£o:', error);
            addSystemMessage('Falha ao conectar.');
            if (!isTryingToReconnect) setTimeout(connectToServer, 3000);
        });
    }

    // CONTROLE DE UI
    const template1 = document.getElementById('template-1');
    const word1 = document.getElementById('word-1');
    const secondLine = document.getElementById('second-line');

    function updateSecondLineVisibility() {
        secondLine.style.display = (template1.value && word1.value) ? 'block' : 'none';
    }
    word1.addEventListener('change', updateSecondLineVisibility);
    template1.addEventListener('change', updateSecondLineVisibility);
    
    // ENVIO DE MENSAGENS
    document.getElementById('send-button').addEventListener('click', enviarMensagem);

    function enviarMensagem() {
        const t1 = template1.value;
        const w1 = word1.value;
        const conj = document.getElementById('conjunction').value;
        const t2 = document.getElementById('template-2').value;
        const w2 = document.getElementById('word-2').value;
        const gesto = document.getElementById('gesture').value;

        if (!t1 || !w1) {
            alert('Precursor, complete a mensagem!');
            return;
        }

        let msg = t1.replace('****', w1);
        if (conj && t2 && w2) msg += ` ${conj} ${t2.replace('****', w2)}`;
        if (gesto) msg += ` ${gesto}`;

        if (socket && socket.connected) {
            socket.emit('enviar-mensagem', { texto: msg });
            clearForm();
        } else {
            addSystemMessage('Erro: N√£o conectado.');
        }
    }

    function clearForm() {
        template1.selectedIndex = 0;
        word1.selectedIndex = 0;
        document.getElementById('conjunction').selectedIndex = 0;
        document.getElementById('template-2').selectedIndex = 0;
        document.getElementById('word-2').selectedIndex = 0;
        document.getElementById('gesture').selectedIndex = 0;
        secondLine.style.display = 'none';
    }

    // GERENCIAMENTO DE CHAT
    function addMessageToChat(text, isSelf = false) {
        if (text === lastMessageText) {
            console.log('Mensagem duplicada ignorada:', text);
            return;
        }
        lastMessageText = text;

        const msgElement = document.createElement('div');
        msgElement.classList.add('message');
        if (isSelf) msgElement.classList.add('self');
        msgElement.textContent = text;

        const chatContainer = document.getElementById('chat-container');
        chatContainer.appendChild(msgElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        saveChatHistory();
    }

    function addSystemMessage(text) {
        const sysElement = document.createElement('div');
        sysElement.classList.add('message', 'system-msg');
        sysElement.textContent = text;

        const chatContainer = document.getElementById('chat-container');
        chatContainer.appendChild(sysElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        saveChatHistory();
    }

    // INICIALIZA√á√ÉO
    window.addEventListener('load', function() {
        // Preenche os dropdowns de palavras
        preencherDropdownPalavras('word-1');
        preencherDropdownPalavras('word-2');
        
        verificarEstadoNotificacoes();
        connectToServer();
    });

    // BOT√ïES
    document.getElementById('clear-history-btn').addEventListener('click', clearChatHistory);
    
    document.getElementById('notif-btn').addEventListener('click', () => {
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                const status = document.getElementById('connection-status');
                if (permission === 'granted') {
                    status.textContent = 'üîî Notifica√ß√µes Ativas';
                    status.style.color = 'lightblue';
                    setTimeout(() => {
                        mostrarNotificacao('Teste de notifica√ß√£o bem-sucedido!');
                    }, 1000);
                } else {
                    status.textContent = 'üîï Notifica√ß√µes Bloqueadas';
                    status.style.color = 'orange';
                }
                alert('Status das notifica√ß√µes: ' + permission);
            });
        } else {
            alert('Seu navegador n√£o suporta notifica√ß√µes');
        }
    });

    // REGISTRO DO SERVICE WORKER PARA PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(function(registration) {
        console.log('ServiceWorker registrado com sucesso: ', registration.scope);
      })
      .catch(function(error) {
        console.log('Falha no registro do ServiceWorker: ', error);
      });
  });
}

// DETECTAR SE EST√Å INSTALADO COMO PWA
function checkPWA() {
  if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('Executando como PWA');
    document.body.classList.add('pwa-mode');
  }
}

// INSTALA√á√ÉO DO PWA
let deferredPrompt;
const installButton = document.createElement('button');
installButton.textContent = 'üì± Instalar App';
installButton.style.cssText = `
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%);
  background: var(--color-accent);
  color: white;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 25px;
  font-weight: bold;
  cursor: pointer;
  z-index: 1000;
  display: none;
`;

document.body.appendChild(installButton);

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installButton.style.display = 'block';
});

installButton.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    installButton.style.display = 'none';
  }
  
  deferredPrompt = null;
});

// Verificar modo PWA ao carregar
checkPWA();
    
</script>
</body>
</html>



